<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>GarageOS ‚Äî Il tuo parco macchine</title>
<meta name="description" content="Gestisci il tuo parco macchine in famiglia">
<meta name="theme-color" content="#0d0f14">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="GarageOS">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="favicon.ico" sizes="32x32">
<link rel="apple-touch-icon" href="icon-192.png">
<script src="https://accounts.google.com/gsi/client"></script>
<style>
  /* Try to load Syne from Google Fonts, fallback gracefully */
  @import url('https://fonts.googleapis.com/css2?family=Syne:wght@700;800&display=swap') layer(fonts);
  @layer fonts { :root { --font-display: 'Syne', 'Trebuchet MS', 'Arial Black', Arial, sans-serif; } }
  :root {
    --bg: #0d0f14;
    --surface: #161923;
    --surface2: #1e2332;
    --border: rgba(255,255,255,0.07);
    --accent: #e8c547;
    --accent2: #4e9fff;
    --green: #3dffa0;
    --yellow: #f5c842;
    --red: #ff4d6d;
    --text: #f0f2f8;
    --text2: #8a90a8;
    --font-display: 'Trebuchet MS', 'Arial Black', 'Franklin Gothic Medium', Arial, sans-serif;
    --font-body: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
    --radius: 16px;
    --trans: 0.35s cubic-bezier(.4,0,.2,1);
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  /* Ensure emoji render as color pictographs everywhere */
  .tab-icon, .notif-chip, .mech-icon-wrap, .empty-icon, .sc-icon,
  .mech-type-btn .mt-icon, .tire-icon, .add-icon, .delete-btn {
    font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji","Twemoji Mozilla","EmojiOne Color","Android Emoji",sans-serif !important;
    font-style: normal;
  }
  html { scroll-behavior: smooth; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-body);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* UPDATE BANNER */
  #update-banner {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
    background: var(--accent); color: #0d0f14;
    padding: 14px 24px; border-radius: 100px;
    font-family: var(--font-display); font-weight: 700; font-size: 14px;
    display: none; align-items: center; gap: 12px;
    z-index: 9999; cursor: pointer;
    box-shadow: 0 8px 32px rgba(232,197,71,0.4);
    animation: slideIn 0.4s ease;
    white-space: nowrap;
  }
  #update-banner.show { display: flex; }
  #update-banner:hover { background: #f5d454; transform: translateX(-50%) translateY(-2px); }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--surface2); border-radius: 4px; }

  /* NOTIFICATION BAR */
  #notif-bar {
    position: sticky; top: 0; z-index: 100;
    background: rgba(13,15,20,0.92);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    min-height: 0;
    overflow: hidden;
    transition: min-height 0.4s ease, padding 0.4s ease;
  }
  #notif-bar.has-notifs { min-height: 52px; padding: 10px 24px; }
  .notif-scroll { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  .notif-chip {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 5px 12px; border-radius: 100px;
    font-size: 12px; font-weight: 500; font-family: var(--font-display), 'Apple Color Emoji', 'Segoe UI Emoji', sans-serif;
    animation: slideIn 0.4s ease;
    cursor: pointer;
    transition: transform 0.2s;
  }
  .notif-chip:hover { transform: scale(1.04); }
  .notif-chip.red { background: rgba(255,77,109,0.15); border: 1px solid rgba(255,77,109,0.4); color: #ff4d6d; }
  .notif-chip.yellow { background: rgba(245,200,66,0.12); border: 1px solid rgba(245,200,66,0.35); color: #f5c842; }
  .notif-label { font-size: 11px; color: var(--text2); margin-right: 4px; }

  /* HEADER */
  header {
    padding: 28px 28px 12px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .logo { font-family: var(--font-display); font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
  .logo span { color: var(--accent); }
  .header-actions { display: flex; gap: 10px; }

  /* NAV TABS */
  .nav-tabs {
    display: flex; gap: 4px; padding: 0 28px 20px;
    overflow-x: auto; scrollbar-width: none;
  }
  .nav-tabs::-webkit-scrollbar { display: none; }
  .tab-btn {
    display: flex; align-items: center; gap: 7px;
    padding: 9px 18px; border-radius: 100px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text2); font-family: var(--font-display);
    font-size: 13px; font-weight: 600;
    cursor: pointer; white-space: nowrap;
    transition: var(--trans);
  }
  .tab-btn:hover { color: var(--text); border-color: rgba(255,255,255,0.18); }
  .tab-btn.active {
    background: var(--accent); color: #0d0f14;
    border-color: var(--accent);
  }
  .tab-btn .tab-icon { font-size: 16px; }

  /* SECTIONS */
  .section { display: none; padding: 0 28px 60px; animation: fadeUp 0.4s ease; }
  .section.active { display: block; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(18px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateX(-10px); }
    to   { opacity: 1; transform: translateX(0); }
  }

  /* SECTION TITLE */
  .section-title {
    font-family: var(--font-display); font-size: 28px; font-weight: 800;
    letter-spacing: -0.5px; margin-bottom: 6px;
  }
  .section-sub { color: var(--text2); font-size: 14px; margin-bottom: 24px; }

  /* BTN */
  .btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 11px 22px; border-radius: 100px;
    font-family: var(--font-display); font-size: 13px; font-weight: 700;
    cursor: pointer; border: none; transition: var(--trans);
  }
  .btn-primary { background: var(--accent); color: #0d0f14; }
  .btn-primary:hover { background: #f5d454; transform: translateY(-1px); box-shadow: 0 8px 24px rgba(232,197,71,0.25); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: rgba(255,255,255,0.2); }
  .btn-danger { background: rgba(255,77,109,0.15); color: var(--red); border: 1px solid rgba(255,77,109,0.3); }
  .btn-danger:hover { background: rgba(255,77,109,0.25); }
  .btn-sm { padding: 7px 14px; font-size: 12px; }

  /* CARD */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    transition: var(--trans);
  }
  .card:hover { border-color: rgba(255,255,255,0.12); transform: translateY(-2px); }

  /* VEHICLE GRID */
  .vehicle-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }

  .vehicle-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 22px;
    position: relative; overflow: hidden;
    transition: var(--trans);
    cursor: default;
  }
  .vehicle-card::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 3px;
  }
  .vehicle-card.ok::before { background: var(--green); }
  .vehicle-card.warn::before { background: var(--yellow); }
  .vehicle-card.danger::before { background: var(--red); }
  .vehicle-card:hover { border-color: rgba(255,255,255,0.14); transform: translateY(-3px); box-shadow: 0 16px 40px rgba(0,0,0,0.3); }

  .vc-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px; }
  .vc-type { margin-bottom: 6px; line-height:1; }
  .vc-plate {
    display: inline-block; padding: 3px 10px;
    background: var(--surface2); border-radius: 6px;
    font-family: var(--font-display); font-weight: 700; font-size: 14px;
    letter-spacing: 1px; color: var(--text);
  }
  .vc-model { font-family: var(--font-display); font-size: 19px; font-weight: 700; margin: 8px 0 4px; }
  .vc-badges { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 14px; }
  .badge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 4px 10px; border-radius: 100px;
    font-size: 11px; font-weight: 600; font-family: var(--font-display);
  }
  .badge.green { background: rgba(61,255,160,0.1); color: var(--green); border: 1px solid rgba(61,255,160,0.25); }
  .badge.yellow { background: rgba(245,200,66,0.1); color: var(--yellow); border: 1px solid rgba(245,200,66,0.3); }
  .badge.red { background: rgba(255,77,109,0.1); color: var(--red); border: 1px solid rgba(255,77,109,0.3); }
  .status-dot { width: 7px; height: 7px; border-radius: 50%; display: inline-block; }
  .status-dot.green { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .status-dot.yellow { background: var(--yellow); box-shadow: 0 0 6px var(--yellow); }
  .status-dot.red { background: var(--red); box-shadow: 0 0 6px var(--red); }

  .vc-actions { display: flex; gap: 8px; margin-top: 16px; }

  /* EMPTY STATE */
  .empty-state {
    text-align: center; padding: 60px 20px;
    color: var(--text2);
  }
  .empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
  .empty-state p { font-size: 15px; }

  /* MODAL */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
    z-index: 200; align-items: center; justify-content: center;
    padding: 20px;
  }
  .modal-overlay.open { display: flex; animation: fadeIn 0.25s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .modal {
    background: var(--surface);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px; padding: 28px;
    width: 100%; max-width: 480px;
    max-height: 90vh; overflow-y: auto;
    animation: modalUp 0.3s cubic-bezier(.34,1.56,.64,1);
  }
  @keyframes modalUp { from { transform: translateY(30px) scale(0.97); } to { transform: none; } }
  .modal-title { font-family: var(--font-display); font-size: 20px; font-weight: 800; margin-bottom: 20px; }
  .form-group { margin-bottom: 16px; }
  .form-label { display: block; font-size: 12px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-family: var(--font-display); }
  .form-input, .form-select, .form-textarea {
    width: 100%; padding: 11px 14px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; color: var(--text);
    font-family: var(--font-body); font-size: 14px;
    line-height: 1.4;
    transition: border-color 0.2s;
    outline: none;
    vertical-align: middle;
    appearance: none; -webkit-appearance: none;
  }
  .form-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%238a90a8' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    padding-right: 36px;
    cursor: pointer;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); }
  .form-select option { background: var(--surface2); }
  .form-textarea { resize: vertical; min-height: 80px; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }

  /* SCADENZE */
  .scadenze-list { display: grid; gap: 12px; }
  .scadenza-item {
    display: flex; align-items: center; gap: 16px;
    padding: 16px 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    transition: var(--trans);
  }
  .scadenza-item:hover { border-color: rgba(255,255,255,0.12); }
  .sc-icon { font-size: 22px; width: 40px; text-align: center; flex-shrink: 0; }
  .sc-info { flex: 1; }
  .sc-title { font-family: var(--font-display); font-weight: 700; font-size: 15px; }
  .sc-sub { color: var(--text2); font-size: 12px; margin-top: 2px; }
  .sc-days {
    font-family: var(--font-display); font-weight: 800; font-size: 22px;
    text-align: right; min-width: 60px;
  }

  /* PNEUMATICI */
  .tire-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
  .tire-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 20px;
    transition: var(--trans);
  }
  .tire-card:hover { border-color: rgba(255,255,255,0.12); transform: translateY(-2px); }
  .tire-header { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
  .tire-icon { font-size: 26px; }
  .tire-season {
    padding: 3px 10px; border-radius: 100px;
    font-size: 11px; font-weight: 700; font-family: var(--font-display);
  }
  .tire-season.invernale { background: rgba(78,159,255,0.15); color: var(--accent2); border: 1px solid rgba(78,159,255,0.3); }
  .tire-season.estivo { background: rgba(232,197,71,0.12); color: var(--accent); border: 1px solid rgba(232,197,71,0.3); }
  .tire-season.allseason { background: rgba(61,255,160,0.1); color: var(--green); border: 1px solid rgba(61,255,160,0.25); }
  .tire-detail { font-size: 13px; color: var(--text2); margin: 4px 0; }
  .tire-detail strong { color: var(--text); font-weight: 500; }

  /* MECCANICA */
  .mech-list { display: grid; gap: 10px; }
  .mech-item {
    display: flex; align-items: center; gap: 16px;
    padding: 16px 20px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); transition: var(--trans);
  }
  .mech-item:hover { border-color: rgba(255,255,255,0.12); }
  .mech-icon-wrap {
    width: 48px; height: 48px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px; flex-shrink: 0;
    background: var(--surface2);
    line-height: 1;
    font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",sans-serif;
  }
  .mech-icon-wrap svg { width: 24px; height: 24px; display: block; }
  .mech-info { flex: 1; min-width: 0; }
  .mech-title { font-family: var(--font-display); font-weight: 700; font-size: 15px; line-height: 1.2; }
  .mech-sub { color: var(--text2); font-size: 12px; margin-top: 3px; line-height: 1.4; }
  .mech-cost {
    font-family: var(--font-display); font-weight: 700; font-size: 16px;
    color: var(--accent); text-align: right; white-space: nowrap;
  }

  /* MECH TYPE GRID (modal) */
  .mech-type-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
    max-height: 320px; overflow-y: auto; padding-right: 4px;
  }
  .mech-type-btn {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 6px; padding: 10px 6px;
    background: var(--surface2); border: 2px solid transparent;
    border-radius: 12px; cursor: pointer; transition: var(--trans);
    font-family: var(--font-display); font-size: 11px; font-weight: 700;
    color: var(--text2); text-align: center; line-height: 1.3;
  }
  .mech-type-btn:hover { border-color: rgba(255,255,255,0.15); color: var(--text); }
  .mech-type-btn.selected { border-color: var(--accent); color: var(--accent); background: rgba(232,197,71,0.08); }
  .mech-type-btn .mt-icon { font-size: 22px; line-height: 1; font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",sans-serif; display:block; }

  /* FILTER ROW */
  .filter-row { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
  .filter-select {
    padding: 8px 14px; background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; color: var(--text); font-family: var(--font-body);
    font-size: 13px; outline: none; cursor: pointer;
  }

  /* PROGRESS BAR */
  .progress-bar { height: 4px; background: var(--surface2); border-radius: 4px; overflow: hidden; margin-top: 8px; }
  .progress-fill { height: 100%; border-radius: 4px; transition: width 1s ease; }

  /* STATS ROW */
  .stats-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; margin-bottom: 24px; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 16px 18px;
  }
  .stat-value { font-family: var(--font-display); font-size: 28px; font-weight: 800; }
  .stat-label { color: var(--text2); font-size: 12px; margin-top: 2px; }

  /* ADD VEHICLE CARD */
  .add-vehicle-card {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 40px 20px; cursor: pointer; min-height: 180px;
    transition: var(--trans); color: var(--text2);
    background: transparent;
  }
  .add-vehicle-card:hover { border-color: var(--accent); color: var(--accent); background: rgba(232,197,71,0.04); transform: translateY(-2px); }
  .add-vehicle-card .add-icon { font-size: 32px; margin-bottom: 8px; }
  .add-vehicle-card span { font-family: var(--font-display); font-weight: 700; font-size: 14px; }

  .delete-btn {
    background: none; border: none; color: var(--text2);
    cursor: pointer; padding: 4px; border-radius: 6px;
    font-size: 16px; transition: color 0.2s;
  }
  .delete-btn:hover { color: var(--red); }
  .edit-btn {
    background: none; border: none; color: var(--text2);
    cursor: pointer; padding: 4px; border-radius: 6px;
    font-size: 16px; transition: color 0.2s;
    font-family: "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",sans-serif;
  }
  .edit-btn:hover { color: var(--accent); }
  .mech-selected-tag {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 4px 10px; border-radius: 100px;
    font-size: 12px; font-weight: 600; font-family: var(--font-display);
    background: rgba(232,197,71,0.1); color: var(--accent);
    border: 1px solid rgba(232,197,71,0.3);
    animation: slideIn 0.2s ease;
  }
  .mech-selected-tag button {
    background: none; border: none; cursor: pointer;
    color: var(--accent); font-size: 14px; line-height:1;
    padding: 0 0 0 2px; opacity: 0.7;
  }
  .mech-selected-tag button:hover { opacity: 1; }


  /* ===== LOGIN SCREEN ===== */
  #login-screen {
    position: fixed; inset: 0; z-index: 999;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    flex-direction: column;
    animation: fadeUp 0.5s ease;
  }
  #login-screen.hidden { display: none; }
  .login-box {
    background: var(--surface);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 24px; padding: 44px 40px;
    text-align: center; max-width: 380px; width: 90%;
    box-shadow: 0 40px 80px rgba(0,0,0,0.4);
  }
  .login-logo { font-family: var(--font-display); font-size: 32px; font-weight: 800; margin-bottom: 6px; }
  .login-logo span { color: var(--accent); }
  .login-sub { color: var(--text2); font-size: 14px; margin-bottom: 36px; }
  .btn-google {
    display: flex; align-items: center; justify-content: center; gap: 12px;
    width: 100%; padding: 14px 24px; border-radius: 14px;
    background: #fff; color: #1a1a1a;
    font-family: var(--font-display); font-size: 15px; font-weight: 700;
    border: none; cursor: pointer;
    transition: var(--trans);
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  }
  .btn-google:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(0,0,0,0.4); }
  .btn-google svg { width: 22px; height: 22px; flex-shrink: 0; }
  .login-note { color: var(--text2); font-size: 11px; margin-top: 20px; line-height: 1.6; }

  /* ===== USER AVATAR ===== */
  .user-avatar {
    width: 34px; height: 34px; border-radius: 50%;
    border: 2px solid var(--border); object-fit: cover;
    cursor: pointer; transition: border-color 0.2s;
    flex-shrink: 0;
  }
  .user-avatar:hover { border-color: var(--accent); }
  .user-menu {
    position: absolute; top: calc(100% + 10px); right: 0;
    background: var(--surface); border: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px; padding: 8px; min-width: 220px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    z-index: 300; animation: fadeUp 0.2s ease;
    display: none;
  }
  .user-menu.open { display: block; }
  .user-menu-header { padding: 10px 12px 14px; border-bottom: 1px solid var(--border); margin-bottom: 6px; }
  .user-menu-name { font-family: var(--font-display); font-weight: 700; font-size: 14px; }
  .user-menu-email { color: var(--text2); font-size: 12px; margin-top: 2px; }
  .user-menu-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px; border-radius: 10px;
    font-size: 13px; cursor: pointer; transition: background 0.2s;
    color: var(--text);
  }
  .user-menu-item:hover { background: var(--surface2); }
  .user-menu-item.danger { color: var(--red); }

  /* ===== FAMIGLIA SECTION ===== */
  .family-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; margin-bottom: 28px; }
  .family-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 18px 20px;
    display: flex; align-items: center; gap: 14px;
    transition: var(--trans);
  }
  .family-card:hover { border-color: rgba(255,255,255,0.14); transform: translateY(-2px); }
  .family-avatar {
    width: 46px; height: 46px; border-radius: 50%;
    object-fit: cover; flex-shrink: 0;
    border: 2px solid var(--border);
  }
  .family-avatar-placeholder {
    width: 46px; height: 46px; border-radius: 50%; flex-shrink: 0;
    background: var(--surface2); border: 2px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; font-family: "Apple Color Emoji","Segoe UI Emoji",sans-serif;
  }
  .family-info { flex: 1; min-width: 0; }
  .family-name { font-family: var(--font-display); font-weight: 700; font-size: 15px; }
  .family-email { color: var(--text2); font-size: 12px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .family-role {
    padding: 3px 10px; border-radius: 100px;
    font-size: 11px; font-weight: 700; font-family: var(--font-display);
    white-space: nowrap;
  }
  .family-role.owner { background: rgba(232,197,71,0.12); color: var(--accent); border: 1px solid rgba(232,197,71,0.3); }
  .family-role.member { background: rgba(78,159,255,0.1); color: var(--accent2); border: 1px solid rgba(78,159,255,0.25); }
  .family-role.pending { background: rgba(245,200,66,0.1); color: var(--yellow); border: 1px solid rgba(245,200,66,0.3); }

  .invite-box {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 24px;
    margin-bottom: 24px;
  }
  .invite-title { font-family: var(--font-display); font-weight: 700; font-size: 16px; margin-bottom: 14px; }
  .invite-row { display: flex; gap: 10px; align-items: center; }
  .invite-input {
    flex: 1; padding: 11px 14px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; color: var(--text);
    font-family: var(--font-body); font-size: 14px; outline: none;
  }
  .invite-input:focus { border-color: var(--accent); }

  .share-link-box {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 12px; padding: 14px 16px;
    display: flex; align-items: center; gap: 10px; margin-top: 16px;
  }
  .share-link-text { flex: 1; font-size: 12px; color: var(--text2); font-family: monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .copy-btn {
    background: var(--accent); color: #0d0f14;
    border: none; border-radius: 8px; padding: 6px 14px;
    font-family: var(--font-display); font-weight: 700; font-size: 12px;
    cursor: pointer; transition: var(--trans); white-space: nowrap;
  }
  .copy-btn:hover { background: #f5d454; }

  .section-divider {
    font-family: var(--font-display); font-size: 12px; font-weight: 700;
    text-transform: uppercase; letter-spacing: 1px;
    color: var(--text2); margin: 20px 0 12px;
  }

  /* Header user area wrapper */
  #header-user-area { position: relative; display: flex; align-items: center; gap: 10px; }

  /* YEAR GROUP */
  .year-group { margin-bottom: 8px; border-radius: var(--radius); overflow: hidden; }
  .year-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 18px; cursor: pointer;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    transition: var(--trans);
    user-select: none;
  }
  .year-header:hover { border-color: rgba(255,255,255,0.15); background: #232736; }
  .year-header.open { border-radius: var(--radius) var(--radius) 0 0; border-bottom-color: transparent; }
  .year-header-left { display: flex; align-items: center; gap: 12px; }
  .year-label {
    font-family: var(--font-display); font-size: 18px; font-weight: 800;
    color: var(--text);
  }
  .year-count {
    display: inline-flex; align-items: center; justify-content: center;
    background: rgba(255,255,255,0.07); border-radius: 100px;
    font-size: 12px; font-weight: 700; font-family: var(--font-display);
    color: var(--text2); padding: 2px 10px;
  }
  .year-cost {
    font-family: var(--font-display); font-weight: 700; font-size: 15px;
    color: var(--accent);
  }
  .year-chevron {
    font-size: 14px; color: var(--text2);
    transition: transform 0.3s ease;
    display: inline-block;
  }
  .year-header.open .year-chevron { transform: rotate(180deg); }
  .year-body {
    border: 1px solid var(--border); border-top: none;
    border-radius: 0 0 var(--radius) var(--radius);
    overflow: hidden;
    display: none;
  }
  .year-body.open { display: block; animation: fadeUp 0.25s ease; }
  .year-body .mech-item { border-radius: 0; border-left: none; border-right: none; border-top: none; }
  .year-body .mech-item:last-child { border-bottom: none; }
  .year-body .mech-item:first-child { border-top: 1px solid var(--border); }

  /* RESPONSIVE */
  @media (max-width: 600px) {
    header, .nav-tabs, .section { padding-left: 16px; padding-right: 16px; }
    .form-row { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- UPDATE BANNER -->
<div id="update-banner" onclick="applyUpdate()">
  üîÑ Nuova versione disponibile ‚Äî Tocca per aggiornare
</div>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">Garage<span>OS</span></div>
    <div style="font-size:12px;color:var(--text2);margin-top:-10px;margin-bottom:6px;font-family:var(--font-body)">Luca Soriente</div>
    <div class="login-sub">Gestisci il tuo parco macchine in famiglia</div>
    <button class="btn-google" onclick="signInWithGoogle()">
      <svg viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.08 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-3.59-13.46-8.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
      Accedi con Google
    </button>
    <p class="login-note">I tuoi dati sono salvati in modo sicuro su Firebase<br>e accessibili solo dal tuo account Google.</p>
  </div>
</div>


<!-- NOTIFICATION BAR -->
<div id="notif-bar">
  <div class="notif-scroll" id="notif-scroll"></div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">Garage<span>OS</span><div style="font-size:11px;font-weight:400;color:var(--text2);letter-spacing:0.5px;margin-top:2px;font-family:var(--font-body)">Luca Soriente</div></div>
  <div id="header-user-area">
    <div id="db-status" style="font-size:11px;color:#8a90a8;font-family:var(--font-body);padding:4px 10px;background:rgba(255,255,255,0.04);border-radius:100px;border:1px solid rgba(255,255,255,0.07)">‚è≥ Connessione...</div>
    <button class="btn btn-primary btn-sm" id="btn-add-vehicle" onclick="openModal('vehicle-modal')" style="display:none">
      <span>Ôºã</span> Aggiungi Veicolo
    </button>
    <img id="user-avatar" class="user-avatar" src="" alt="Utente" style="display:none" onclick="toggleUserMenu()">
    <div class="user-menu" id="user-menu">
      <div class="user-menu-header">
        <div class="user-menu-name" id="menu-user-name">‚Äî</div>
        <div class="user-menu-email" id="menu-user-email">‚Äî</div>
      </div>
      <div class="user-menu-item" onclick="switchTab('famiglia'); toggleUserMenu()">üë®‚Äçüë©‚Äçüëß Gestione Famiglia</div>
      <div class="user-menu-item danger" onclick="signOut()">üö™ Esci</div>
    </div>
  </div>
</header>

<!-- NAV -->
<div class="nav-tabs">
  <button class="tab-btn active" onclick="switchTab('dashboard')" id="tab-dashboard">
    <span class="tab-icon">üè†</span> Dashboard
  </button>
  <button class="tab-btn" onclick="switchTab('scadenze')" id="tab-scadenze">
    <span class="tab-icon">üìÖ</span> Scadenze
  </button>
  <button class="tab-btn" onclick="switchTab('pneumatici')" id="tab-pneumatici">
    <span class="tab-icon">üîÑ</span> Pneumatici
  </button>
  <button class="tab-btn" onclick="switchTab('meccanica')" id="tab-meccanica">
    <span class="tab-icon">üîß</span> Meccanica
  </button>
  <button class="tab-btn" onclick="switchTab('famiglia')" id="tab-famiglia">
    <span class="tab-icon">üë®‚Äçüë©‚Äçüëß</span> Famiglia
  </button>
</div>

<!-- DASHBOARD -->
<div class="section active" id="section-dashboard">
  <div class="section-title">Il tuo Parco Macchine</div>
  <div class="section-sub">Panoramica veicoli e stato generale</div>
  <div class="stats-row" id="stats-row"></div>
  <div class="vehicle-grid" id="vehicle-grid">
    <div class="add-vehicle-card" onclick="openModal('vehicle-modal')">
      <div class="add-icon">üöó</div>
      <span>Aggiungi il tuo primo veicolo</span>
    </div>
  </div>
</div>

<!-- SCADENZE -->
<div class="section" id="section-scadenze">
  <div class="section-title">Gestione Scadenze</div>
  <div class="section-sub">Bollo, revisione e altre scadenze importanti</div>
  <div class="filter-row">
    <select class="filter-select" id="scad-filter-vehicle" onchange="renderScadenze()">
      <option value="">Tutti i veicoli</option>
    </select>
  </div>
  <div class="scadenze-list" id="scadenze-list"></div>
</div>

<!-- PNEUMATICI -->
<div class="section" id="section-pneumatici">
  <div class="section-title">Diario Pneumatici</div>
  <div class="section-sub">Storico cambi gomme e programmazione stagionale</div>
  <div class="filter-row">
    <select class="filter-select" id="tire-filter-vehicle" onchange="renderPneumatici()">
      <option value="">Tutti i veicoli</option>
    </select>
    <button class="btn btn-primary btn-sm" onclick="openModal('tire-modal')">Ôºã Registra Cambio</button>
  </div>
  <div class="tire-grid" id="tire-grid"></div>
</div>

<!-- MECCANICA -->
<div class="section" id="section-meccanica">
  <div class="section-title">Registro Meccanica</div>
  <div class="section-sub">Storico interventi, costi e officine</div>
  <div class="filter-row">
    <select class="filter-select" id="mech-filter-vehicle" onchange="renderMeccanica()">
      <option value="">Tutti i veicoli</option>
    </select>
    <select class="filter-select" id="mech-filter-type" onchange="renderMeccanica()">
      <option value="">Tutti i tipi</option>
      <option value="olio_motore">Olio Motore</option>
      <option value="filtro_olio">Filtro Olio</option>
      <option value="filtro_aria">Filtro Aria</option>
      <option value="filtro_carburante">Filtro Carburante</option>
      <option value="filtro_abitacolo">Filtro Abitacolo</option>
      <option value="candele">Candele/Candelette</option>
      <option value="lavavetri">Liquido Lavavetri</option>
      <option value="batteria">Batteria</option>
      <option value="spazzole">Spazzole Tergicristallo</option>
      <option value="pompa_acqua">Pompa Acqua</option>
      <option value="paraflu">Paraflu</option>
      <option value="cavi_candele">Sost. Cavi Candele</option>
      <option value="bobina">Sostituzione Bobina</option>
      <option value="cuffie_giunti">Cuffie Giunti</option>
      <option value="bracci_ant">Bracci Ant.</option>
      <option value="bracci_post">Bracci Post.</option>
      <option value="marmitta_centr">Marmitta Centr.</option>
      <option value="marmitta_post">Marmitta Post.</option>
      <option value="cinghia_dist">Cinghia di Distribuzione</option>
      <option value="cinghia_org">Cinghia Organi Aus.</option>
      <option value="freni_ant">Freni Anteriori</option>
      <option value="freni_post">Freni Posteriori</option>
      <option value="dischi_ant">Dischi Freni Ant.</option>
      <option value="dischi_post">Dischi Freni Post.</option>
      <option value="tagliando">Tagliando</option>
      <option value="altro">Altro</option>
    </select>
    <button class="btn btn-primary btn-sm" onclick="openModal('mech-modal')">Ôºã Aggiungi Intervento</button>
  </div>
  <div class="mech-list" id="mech-list"></div>
</div>


<!-- MODAL: AGGIUNGI VEICOLO -->
<div class="modal-overlay" id="vehicle-modal">
  <div class="modal">
    <div class="modal-title" id="vehicle-modal-title">üöó Aggiungi Veicolo</div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Targa *</label>
        <input type="hidden" id="v-edit-id" value="">
        <input type="text" class="form-input" id="v-plate" placeholder="AB123CD" style="text-transform:uppercase">
      </div>
      <div class="form-group">
        <label class="form-label">Tipo</label>
        <select class="form-select" id="v-type">
          <option value="auto">üöó Auto</option>
          <option value="moto">üèçÔ∏è Moto</option>
          <option value="suv">üöô SUV</option>
          <option value="furgone">üöê Furgone</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Modello *</label>
      <input type="text" class="form-input" id="v-model" placeholder="es. Volkswagen Golf 1.6 TDI">
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Anno</label>
        <input type="number" class="form-input" id="v-year" placeholder="2020">
      </div>
      <div class="form-group">
        <label class="form-label">Km attuali</label>
        <input type="number" class="form-input" id="v-km" placeholder="50000">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Data rilevamento km</label>
        <input type="date" class="form-input" id="v-km-date">
      </div>
      <div class="form-group">
        <label class="form-label">&nbsp;</label>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Scadenza Bollo</label>
        <input type="date" class="form-input" id="v-bollo">
      </div>
      <div class="form-group">
        <label class="form-label">Costo Bollo (‚Ç¨)</label>
        <input type="number" class="form-input" id="v-bollo-cost" placeholder="es. 180">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Scadenza Revisione</label>
        <input type="date" class="form-input" id="v-revisione">
      </div>
      <div class="form-group">
        <label class="form-label">Costo Revisione (‚Ç¨)</label>
        <input type="number" class="form-input" id="v-revisione-cost" placeholder="es. 80">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Scadenza Assicurazione</label>
        <input type="date" class="form-input" id="v-assicurazione">
      </div>
      <div class="form-group">
        <label class="form-label">Costo Assicurazione (‚Ç¨)</label>
        <input type="number" class="form-input" id="v-assicurazione-cost" placeholder="es. 650">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Compagnia Assicurativa</label>
      <input type="text" class="form-input" id="v-assicurazione-company" placeholder="es. Generali, UnipolSai...">
    </div>
    <div class="form-group">
      <label class="form-label">Note</label>
      <textarea class="form-textarea" id="v-note" placeholder="Note aggiuntive..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('vehicle-modal')">Annulla</button>
      <button id="btn-save-vehicle" class="btn btn-primary" onclick="saveVehicle()">Salva Veicolo</button>
    </div>
  </div>
</div>

<!-- MODAL: PNEUMATICI -->
<div class="modal-overlay" id="tire-modal">
  <div class="modal">
    <div class="modal-title" id="tire-modal-title">üîÑ Registra Cambio Gomme</div>
    <div class="form-group">
      <label class="form-label">Veicolo *</label>
      <input type="hidden" id="t-edit-id" value="">
      <select class="form-select" id="t-vehicle"></select>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Stagione *</label>
        <select class="form-select" id="t-season">
          <option value="invernale">‚ùÑÔ∏è Invernale</option>
          <option value="estivo">‚òÄÔ∏è Estivo</option>
          <option value="allseason">üå¶Ô∏è 4 Stagioni</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Data cambio</label>
        <input type="date" class="form-input" id="t-date">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Km al cambio</label>
        <input type="number" class="form-input" id="t-km" placeholder="es. 45000">
      </div>
      <div class="form-group">
        <label class="form-label">Prossimo cambio (km)</label>
        <input type="number" class="form-input" id="t-km-next" placeholder="es. 85000">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Marca Gomme</label>
        <input type="text" class="form-input" id="t-brand" placeholder="es. Michelin">
      </div>
      <div class="form-group">
        <label class="form-label">Misura</label>
        <input type="text" class="form-input" id="t-size" placeholder="es. 205/55 R16">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Officina / Note</label>
      <textarea class="form-textarea" id="t-note" placeholder="Note sul cambio..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('tire-modal')">Annulla</button>
      <button id="btn-save-tire" class="btn btn-primary" onclick="saveTire()">Salva</button>
    </div>
  </div>
</div>

<!-- MODAL: MECCANICA -->
<div class="modal-overlay" id="mech-modal">
  <div class="modal" style="max-width:560px">
    <div class="modal-title" id="mech-modal-title">üîß Aggiungi Intervento</div>
    <div class="form-group">
      <label class="form-label">Veicolo *</label>
      <input type="hidden" id="m-edit-id" value="">
      <select class="form-select" id="m-vehicle"></select>
    </div>
    <div class="form-group">
      <label class="form-label">Tipi di Intervento * <span style="font-weight:400;text-transform:none;letter-spacing:0;font-size:11px;color:var(--text2)">(puoi selezionarne pi√π di uno)</span></label>
      <input type="hidden" id="m-type" value="">
      <div class="mech-type-grid" id="mech-type-grid"></div>
      <div id="m-selected-tags" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px;min-height:0"></div>
      <div id="m-type-error" style="color:var(--red);font-size:12px;margin-top:6px;display:none">Seleziona almeno un tipo di intervento</div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Data *</label>
        <input type="date" class="form-input" id="m-date">
      </div>
      <div class="form-group">
        <label class="form-label">Km</label>
        <input type="number" class="form-input" id="m-km" placeholder="es. 60000">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Costo (‚Ç¨)</label>
        <input type="number" class="form-input" id="m-cost" placeholder="es. 250">
      </div>
      <div class="form-group">
        <label class="form-label">Officina</label>
        <input type="text" class="form-input" id="m-garage" placeholder="es. Autofficina Rossi">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Note</label>
      <textarea class="form-textarea" id="m-note" placeholder="Dettagli intervento..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('mech-modal')">Annulla</button>
      <button id="btn-save-mech" class="btn btn-primary" onclick="saveMech()">Salva</button>
    </div>
  </div>
</div>


<!-- FAMIGLIA -->
<div class="section" id="section-famiglia">
  <div class="section-title">Garage di Famiglia</div>
  <div class="section-sub">Condividi il garage con i tuoi familiari</div>

  <div class="invite-box" id="invite-box">
    <div class="invite-title">‚úâÔ∏è Invita un membro</div>
    <div class="invite-row">
      <input type="email" class="invite-input" id="invite-email" placeholder="email@esempio.com">
      <button class="btn btn-primary btn-sm" onclick="sendInvite()">Invita</button>
    </div>
    <div class="share-link-box" id="share-link-box" style="display:none">
      <span class="share-link-text" id="share-link-text">‚Äî</span>
      <button class="copy-btn" onclick="copyShareLink()">üìã Copia</button>
    </div>
    <div id="invite-feedback" style="font-size:12px;color:var(--green);margin-top:10px;display:none"></div>
  </div>

  <div class="section-divider">Membri del Garage</div>
  <div class="family-grid" id="family-grid"></div>

  <div class="section-divider">Veicoli condivisi</div>
  <div style="color:var(--text2);font-size:13px;margin-bottom:8px">I veicoli aggiunti sono visibili a tutti i membri del garage.</div>
  <div class="vehicle-grid" id="family-vehicle-grid"></div>
</div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
import {
  getFirestore, collection, doc,
  onSnapshot, setDoc, deleteDoc, query, orderBy, getDocs, addDoc, getDoc
} from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
import {
  getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult,
  onAuthStateChanged, signOut as fbSignOut,
  browserLocalStoragePersistence, setPersistence
} from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js';

// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyDPNSgCqWvfyJ6YSP_E9JU9HufgtwYJfII",
  authDomain: "garageos-879bc.firebaseapp.com",
  projectId: "garageos-879bc",
  storageBucket: "garageos-879bc.firebasestorage.app",
  messagingSenderId: "388016073061",
  appId: "1:388016073061:web:8b3dd0073f622bd950598c"
};

const app  = initializeApp(firebaseConfig);
const db   = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// ===== STATE =====
let currentUser = null;
let garageId    = null;   // The shared garage ID (owner's uid)
let isOwner     = false;
let data = { vehicles: [], tires: [], mechs: [], members: [] };
let _unsubscribers = [];

// ===== EXPOSE TO GLOBAL =====
window.openModal        = openModal;
window.openEditVehicle  = openEditVehicle;
window.openEditTire     = openEditTire;
window.openEditMech     = openEditMech;
window.closeModal       = closeModal;
window.switchTab        = switchTab;
window.saveVehicle      = saveVehicle;
window.saveTire         = saveTire;
window.saveMech         = saveMech;
window.deleteVehicle    = deleteVehicle;
window.deleteTire       = deleteTire;
window.deleteMech       = deleteMech;
window.selectMechType   = selectMechType;
window.toggleMechType   = toggleMechType;
window.removeMechTypeTag = removeMechTypeTag;
window.renderScadenze   = renderScadenze;
window.renderPneumatici = renderPneumatici;
window.renderMeccanica  = renderMeccanica;
window.signInWithGoogle = signInWithGoogle;
window.signOut          = signOutUser;
window.toggleUserMenu   = toggleUserMenu;
window.sendInvite       = sendInvite;
window.copyShareLink    = copyShareLink;
window._showToast       = _showToast;

// ===== AUTH =====
function _isPWA() {
  return window.matchMedia('(display-mode: standalone)').matches
    || window.navigator.standalone === true;
}

// Forza persistenza localStorage ‚Äî sopravvive a redirect, refresh e chiusura app
setPersistence(auth, browserLocalStoragePersistence).catch(e => console.warn('Persistence error:', e));

// Gestisci subito il risultato di un eventuale redirect precedente
getRedirectResult(auth).then(result => {
  if (result?.user) {
    console.log('‚úÖ Redirect login OK:', result.user.email);
    localStorage.removeItem('garageos_auth_pending');
  }
}).catch(e => {
  localStorage.removeItem('garageos_auth_pending');
  if (e.code && e.code !== 'auth/no-auth-event') {
    console.error('Redirect result error:', e.code, e.message);
  }
});

async function signInWithGoogle() {
  provider.setCustomParameters({ prompt: 'select_account' });

  // Prima tenta sempre il popup ‚Äî funziona su browser mobile e desktop
  try {
    await signInWithPopup(auth, provider);
    localStorage.removeItem('garageos_auth_pending');
    return;
  } catch(e) {
    if (e.code === 'auth/popup-closed-by-user' || e.code === 'auth/cancelled-popup-request') {
      return; // Utente ha chiuso, nessun errore
    }
    if (e.code === 'auth/unauthorized-domain') {
      alert('Dominio non autorizzato.\nAggiungi lucsor.github.io in Firebase Console ‚Üí Authentication ‚Üí Authorized domains');
      return;
    }
    // Popup bloccato (tipico in PWA standalone) ‚Üí fallback redirect
    console.warn('Popup fallito, uso redirect:', e.code);
  }

  // Fallback: redirect (PWA standalone o browser con popup bloccati)
  try {
    localStorage.setItem('garageos_auth_pending', '1');
    // Mostra messaggio di attesa prima del redirect
    const loginBox = document.querySelector('.login-box');
    if (loginBox) {
      loginBox.innerHTML = `
        <div class="login-logo">Garage<span>OS</span></div>
        <div style="color:var(--text2);margin-top:20px;font-size:15px;font-family:var(--font-display)">‚è≥ Reindirizzamento a Google...</div>
        <div style="color:var(--text2);font-size:12px;margin-top:8px">Verrai riportato sull'app dopo il login</div>
      `;
    }
    await signInWithRedirect(auth, provider);
  } catch(e) {
    localStorage.removeItem('garageos_auth_pending');
    alert('Errore accesso: ' + e.message);
  }
}

async function signOutUser() {
  _unsubscribers.forEach(u => u());
  _unsubscribers = [];
  if (_membershipWatcher) { _membershipWatcher(); _membershipWatcher = null; }
  await fbSignOut(auth);
  currentUser = null; garageId = null;
  data = { vehicles: [], tires: [], mechs: [], members: [] };
  document.getElementById('login-screen').classList.remove('hidden');
  document.getElementById('user-avatar').style.display = 'none';
  document.getElementById('btn-add-vehicle').style.display = 'none';
  toggleUserMenu(false);
  renderAll();
}

function toggleUserMenu(force) {
  const m = document.getElementById('user-menu');
  if (force === false) { m.classList.remove('open'); return; }
  m.classList.toggle('open');
}
document.addEventListener('click', e => {
  if (!e.target.closest('#header-user-area')) toggleUserMenu(false);
});

onAuthStateChanged(auth, async user => {
  if (!user) {
    // Se redirect in corso mostra schermata di attesa invece del login
    if (localStorage.getItem('garageos_auth_pending')) {
      document.getElementById('login-screen').classList.remove('hidden');
      const loginBox = document.querySelector('.login-box');
      if (loginBox) loginBox.innerHTML = `
        <div class="login-logo">Garage<span>OS</span></div>
        <div style="color:var(--text2);margin-top:20px;font-size:15px;font-family:var(--font-display)">‚è≥ Accesso in corso...</div>
        <div style="color:var(--text2);font-size:12px;margin-top:8px">Completa il login su Google e torna qui</div>
        <button class="btn-google" style="margin-top:24px;opacity:0.6;cursor:not-allowed" disabled>
          Attendere...
        </button>
      `;
      return;
    }
    document.getElementById('login-screen').classList.remove('hidden');
    return;
  }
  currentUser = user;
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('btn-add-vehicle').style.display = '';

  // Update avatar
  const avatarEl = document.getElementById('user-avatar');
  avatarEl.src = user.photoURL || '';
  avatarEl.style.display = user.photoURL ? '' : 'none';
  document.getElementById('menu-user-name').textContent = user.displayName || user.email;
  document.getElementById('menu-user-email').textContent = user.email;

  // Prima controlla se c'√® un link di join da gestire
  const joinHandled = await checkJoinLink();
  if (!joinHandled) {
    // Nessun join link: risolvi il garage normalmente
    await resolveGarage(user);
    startListeners();
  }
});

// ===== GARAGE RESOLUTION =====
async function resolveGarage(user) {
  // Cerca in tutti i garage se l'utente √® membro attivo (per uid O per email)
  const snap = await getDocs(collection(db, 'garages'));
  let foundGarage = null;

  snap.forEach(d => {
    if (d.id === user.uid) return; // skip il proprio garage
    const members = d.data().members || [];
    const isMember = members.find(m =>
      (m.uid === user.uid || m.email === user.email.toLowerCase()) && m.status === 'active'
    );
    if (isMember) foundGarage = d.id;
  });

  if (foundGarage) {
    garageId = foundGarage;
    isOwner = false;
    await _syncMemberUid(foundGarage, user);
  } else {
    // Usa il proprio garage
    garageId = user.uid;
    isOwner = true;
    const garageRef = doc(db, 'garages', user.uid);
    const garageSnap = await getDoc(garageRef);
    if (!garageSnap.exists()) {
      await setDoc(garageRef, {
        ownerUid: user.uid,
        ownerName: user.displayName || user.email,
        ownerEmail: user.email,
        ownerPhoto: user.photoURL || '',
        members: [],
        createdAt: new Date().toISOString(),
      });
    }
    // Ascolta in tempo reale il proprio garage doc:
    // se qualcuno ci aggiunge come membro attivo, rientra nel garage giusto
    _watchForMembership(user);
  }
}

// Ascolta TUTTI i garage per vedere se l'utente diventa membro attivo
// (es: quando il proprietario ha gi√† creato l'invito e l'utente fa login)
let _membershipWatcher = null;
function _watchForMembership(user) {
  if (_membershipWatcher) { _membershipWatcher(); _membershipWatcher = null; }
  _membershipWatcher = onSnapshot(
    collection(db, 'garages'),
    snap => {
      snap.forEach(d => {
        if (d.id === user.uid) return;
        const members = d.data().members || [];
        const isMember = members.find(m =>
          (m.uid === user.uid || m.email === user.email.toLowerCase()) && m.status === 'active'
        );
        if (isMember && garageId === user.uid) {
          // Trovato! Passa al garage condiviso
          console.log('Membership trovata nel garage:', d.id);
          garageId = d.id;
          isOwner  = false;
          if (_membershipWatcher) { _membershipWatcher(); _membershipWatcher = null; }
          // Riavvia i listener sul garage giusto
          _unsubscribers.forEach(u => u()); _unsubscribers = [];
          startListeners();
          _syncMemberUid(d.id, user);
          _showToast('‚úÖ Sei entrato nel garage di famiglia!', 'green');
        }
      });
    },
    err => console.error('membership watcher err:', err)
  );
}

// Aggiorna uid/nome/foto del membro se era ancora vuoto
async function _syncMemberUid(gid, user) {
  const garageRef = doc(db, 'garages', gid);
  const snap = await getDoc(garageRef);
  if (!snap.exists()) return;
  const members = snap.data().members || [];
  let changed = false;
  members.forEach(m => {
    if (m.email === user.email.toLowerCase() && (m.uid !== user.uid || !m.name || m.status !== 'active')) {
      m.uid = user.uid;
      m.name = user.displayName || user.email;
      m.photo = user.photoURL || '';
      m.status = 'active';
      changed = true;
    }
  });
  if (changed) await setDoc(garageRef, { members }, { merge: true });
}

// ===== REAL-TIME LISTENERS =====
function startListeners() {
  setStatus('loading');
  _unsubscribers.forEach(u => u());
  _unsubscribers = [];

  const base = `garages/${garageId}`;

  const u1 = onSnapshot(
    query(collection(db, base + '/vehicles'), orderBy('plate')),
    snap => { data.vehicles = snap.docs.map(d => ({ id: d.id, ...d.data() })); setStatus('online'); renderAll(); },
    err => { console.error(err); setStatus('error'); }
  );
  const u2 = onSnapshot(
    query(collection(db, base + '/tires'), orderBy('date', 'desc')),
    snap => { data.tires = snap.docs.map(d => ({ id: d.id, ...d.data() })); renderAll(); },
    err => console.error(err)
  );
  const u3 = onSnapshot(
    query(collection(db, base + '/mechs'), orderBy('date', 'desc')),
    snap => { data.mechs = snap.docs.map(d => ({ id: d.id, ...d.data() })); renderAll(); },
    err => console.error(err)
  );
  const u4 = onSnapshot(
    doc(db, 'garages', garageId),
    snap => {
      if (!snap.exists()) return;
      const prevMembers = JSON.stringify(data.members);
      data.members = snap.data().members || [];
      data.garageOwner = {
        name:  snap.data().ownerName,
        email: snap.data().ownerEmail,
        photo: snap.data().ownerPhoto,
        uid:   snap.data().ownerUid
      };
      // Notifica se un nuovo membro ha accettato
      if (prevMembers !== '[]' && prevMembers !== JSON.stringify(data.members)) {
        const prev = JSON.parse(prevMembers);
        const newActive = data.members.filter(m => m.status === 'active');
        const wasActive = prev.filter(m => m.status === 'active');
        if (newActive.length > wasActive.length) {
          const joined = newActive.find(nm => !wasActive.some(w => w.email === nm.email));
          if (joined) _showToast('\u2705 ' + (joined.name || joined.email) + ' e\'entrato nel garage!', 'green');
        }
      }
      renderFamiglia();
    },
    err => console.error(err)
  );

  _unsubscribers = [u1, u2, u3, u4];
}

// ===== STATUS =====
function setStatus(state) {
  const el = document.getElementById('db-status');
  if (!el) return;
  const cfg = {
    loading: { color: '#f5c842', text: '‚è≥ Connessione...' },
    online:  { color: '#3dffa0', text: '‚óè Firebase sync' },
    error:   { color: '#ff4d6d', text: '‚óè Offline' },
  }[state];
  el.style.color = cfg.color;
  el.textContent = cfg.text;
}

// ===== FIRESTORE CRUD =====
function vCol(name) { return collection(db, `garages/${garageId}/${name}`); }
function vDoc(name, id) { return doc(db, `garages/${garageId}/${name}/${id}`); }

async function addVehicle(v)  { const { id, ...rest } = v; await setDoc(vDoc('vehicles', id), rest); }
async function addTire(t)     { const { id, ...rest } = t; await setDoc(vDoc('tires', id), rest); }
async function addMech(m)     { const { id, ...rest } = m; await setDoc(vDoc('mechs', id), rest); }

async function removeVehicle(id) {
  await deleteDoc(vDoc('vehicles', id));
  await Promise.all([
    ...data.tires.filter(t => t.vehicleId === id).map(t => deleteDoc(vDoc('tires', t.id))),
    ...data.mechs.filter(m => m.vehicleId === id).map(m => deleteDoc(vDoc('mechs', m.id))),
  ]);
}
async function removeTire(id) { await deleteDoc(vDoc('tires', id)); }
async function removeMech(id) { await deleteDoc(vDoc('mechs', id)); }

// ===== FAMIGLIA =====
async function sendInvite() {
  const email = document.getElementById('invite-email').value.trim().toLowerCase();
  if (!email || !email.includes('@')) { alert('Inserisci un indirizzo email valido'); return; }
  if (!isOwner) { alert('Solo il proprietario del garage pu√≤ invitare membri'); return; }

  const garageRef = doc(db, 'garages', garageId);
  const snap = await getDoc(garageRef);
  const members = snap.data().members || [];

  if (members.find(m => m.email === email)) {
    alert('Questo utente √® gi√† stato invitato'); return;
  }

  const newMember = {
    email,
    uid: '',
    name: email.split('@')[0],
    photo: '',
    status: 'pending',
    invitedAt: new Date().toISOString(),
  };
  members.push(newMember);
  await setDoc(garageRef, { members }, { merge: true });

  // Generate invite link
  const link = `${window.location.href.split('?')[0]}?join=${garageId}&email=${encodeURIComponent(email)}`;
  document.getElementById('share-link-text').textContent = link;
  document.getElementById('share-link-box').style.display = 'flex';
  document.getElementById('invite-feedback').textContent = '‚úÖ Invito registrato per ' + email + ' ‚Äî copia il link e mandaglielo!';
  document.getElementById('invite-feedback').style.display = 'block';
  document.getElementById('invite-email').value = '';
}

function copyShareLink() {
  const text = document.getElementById('share-link-text').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = '‚úÖ Copiato!';
    setTimeout(() => btn.textContent = 'üìã Copia', 2000);
  });
}

// Check for join link on load ‚Äî returns true if a join was processed
async function checkJoinLink() {
  const params = new URLSearchParams(window.location.search);
  const joinId = params.get('join');
  const joinEmail = params.get('email');
  if (!joinId || !joinEmail || !currentUser) return false;

  if (currentUser.email.toLowerCase() !== joinEmail.toLowerCase()) {
    alert(`Questo invito √® per ${joinEmail}.\nHai effettuato l'accesso con ${currentUser.email}.\nEsci e accedi con l'account corretto.`);
    window.history.replaceState({}, '', window.location.pathname);
    // Risolvi garage normale per l'utente attuale
    await resolveGarage(currentUser);
    startListeners();
    return true;
  }

  // Attiva il membro nel garage del proprietario
  const garageRef = doc(db, 'garages', joinId);
  const snap = await getDoc(garageRef);
  if (!snap.exists()) {
    alert('Garage non trovato. Il link potrebbe essere scaduto.');
    await resolveGarage(currentUser);
    startListeners();
    return true;
  }

  const members = snap.data().members || [];
  const idx = members.findIndex(m => m.email === joinEmail.toLowerCase());
  if (idx >= 0) {
    members[idx].uid    = currentUser.uid;
    members[idx].name   = currentUser.displayName || currentUser.email;
    members[idx].photo  = currentUser.photoURL || '';
    members[idx].status = 'active';
  } else {
    // Non era nella lista inviti ‚Äî aggiungilo come attivo direttamente
    members.push({
      email: currentUser.email.toLowerCase(),
      uid: currentUser.uid,
      name: currentUser.displayName || currentUser.email,
      photo: currentUser.photoURL || '',
      status: 'active',
      invitedAt: new Date().toISOString(),
    });
  }
  await setDoc(garageRef, { members }, { merge: true });

  // Imposta garage condiviso
  garageId = joinId;
  isOwner  = false;
  window.history.replaceState({}, '', window.location.pathname);
  startListeners();
  // Mostra notifica non bloccante
  _showToast('‚úÖ Sei entrato nel garage di famiglia!', 'green');
  return true;
}

// Toast non bloccante (sostituisce alert per azioni non critiche)
function _showToast(msg, color = 'green') {
  let t = document.getElementById('_toast');
  if (!t) {
    t = document.createElement('div');
    t.id = '_toast';
    t.style.cssText = `position:fixed;bottom:28px;left:50%;transform:translateX(-50%);
      padding:12px 24px;border-radius:100px;font-family:var(--font-display);font-weight:700;
      font-size:14px;z-index:9999;transition:opacity 0.4s;pointer-events:none;
      box-shadow:0 8px 32px rgba(0,0,0,0.4)`;
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.background = color === 'green' ? 'var(--green)' : color === 'red' ? 'var(--red)' : 'var(--accent)';
  t.style.color = '#0d0f14';
  t.style.opacity = '1';
  clearTimeout(t._timer);
  t._timer = setTimeout(() => { t.style.opacity = '0'; }, 3000);
}

// ===== UTILS =====
function daysUntil(dateStr) {
  if (!dateStr) return null;
  const now = new Date(); now.setHours(0,0,0,0);
  const d = new Date(dateStr); d.setHours(0,0,0,0);
  return Math.ceil((d - now) / 86400000);
}
function badgeClass(days) {
  if (days === null) return '';
  if (days <= 10) return 'red';
  if (days <= 60) return 'yellow';
  return 'green';
}
function typeIcon(type) {
  const svgs = {
    auto: `<svg viewBox="0 0 48 48" width="38" height="38"><rect x="6" y="18" width="36" height="16" rx="5" fill="#4e9fff" opacity=".18"/><path d="M10 22l4-8h20l4 8" stroke="#4e9fff" stroke-width="2" fill="none" stroke-linejoin="round"/><rect x="6" y="22" width="36" height="12" rx="4" fill="#4e9fff" opacity=".35"/><rect x="5" y="28" width="38" height="8" rx="4" fill="#4e9fff" opacity=".6"/><circle cx="14" cy="36" r="4" fill="#1e2332" stroke="#4e9fff" stroke-width="2"/><circle cx="34" cy="36" r="4" fill="#1e2332" stroke="#4e9fff" stroke-width="2"/><rect x="16" y="22" width="16" height="7" rx="2" fill="#4e9fff" opacity=".4"/></svg>`,
    moto: `<svg viewBox="0 0 48 48" width="38" height="38"><circle cx="10" cy="32" r="7" fill="none" stroke="#e8c547" stroke-width="2.5"/><circle cx="38" cy="32" r="7" fill="none" stroke="#e8c547" stroke-width="2.5"/><path d="M10 32 L18 18 L28 18 L36 28 L38 32" stroke="#e8c547" stroke-width="2" fill="none" stroke-linejoin="round"/><path d="M28 18 L32 12 L38 12" stroke="#e8c547" stroke-width="2" fill="none"/><circle cx="10" cy="32" r="3" fill="#e8c547"/><circle cx="38" cy="32" r="3" fill="#e8c547"/></svg>`,
    suv: `<svg viewBox="0 0 48 48" width="38" height="38"><rect x="5" y="20" width="38" height="14" rx="3" fill="#3dffa0" opacity=".2"/><path d="M8 20l5-10h22l5 10" stroke="#3dffa0" stroke-width="2" fill="none" stroke-linejoin="round"/><rect x="5" y="20" width="38" height="15" rx="3" fill="#3dffa0" opacity=".3"/><rect x="9" y="20" width="30" height="8" rx="2" fill="#3dffa0" opacity=".4"/><circle cx="14" cy="36" r="5" fill="#161923" stroke="#3dffa0" stroke-width="2"/><circle cx="34" cy="36" r="5" fill="#161923" stroke="#3dffa0" stroke-width="2"/></svg>`,
    furgone: `<svg viewBox="0 0 48 48" width="38" height="38"><rect x="5" y="16" width="38" height="20" rx="3" fill="#a78bfa" opacity=".25"/><rect x="5" y="16" width="20" height="20" rx="3" fill="#a78bfa" opacity=".2"/><rect x="7" y="18" width="14" height="10" rx="2" fill="#a78bfa" opacity=".5"/><circle cx="13" cy="37" r="4" fill="#161923" stroke="#a78bfa" stroke-width="2"/><circle cx="35" cy="37" r="4" fill="#161923" stroke="#a78bfa" stroke-width="2"/><rect x="25" y="16" width="18" height="20" rx="2" fill="#a78bfa" opacity=".15"/></svg>`,
  };
  return svgs[type] || svgs.auto;
}
const MECH_TYPES = [
  { id: 'olio_motore',    icon: 'üõ¢Ô∏è',  label: 'Olio Motore',              color: '#f59e0b' },
  { id: 'filtro_olio',    icon: 'üîò',  label: 'Filtro Olio',              color: '#f59e0b' },
  { id: 'filtro_aria',    icon: 'üí®',  label: 'Filtro Aria',              color: '#60a5fa' },
  { id: 'filtro_carburante', icon: '‚õΩ', label: 'Filtro Carburante',      color: '#f97316' },
  { id: 'filtro_abitacolo', icon: 'üå¨Ô∏è', label: 'Filtro Abitacolo',       color: '#34d399' },
  { id: 'candele',        icon: '‚ö°',  label: 'Candele / Candelette',     color: '#facc15' },
  { id: 'lavavetri',      icon: 'üíß',  label: 'Liquido Lavavetri',        color: '#38bdf8' },
  { id: 'batteria',       icon: 'üîã',  label: 'Batteria',                 color: '#4ade80' },
  { id: 'spazzole',       icon: 'ü™ü',  label: 'Spazzole Tergicristallo',  color: '#94a3b8' },
  { id: 'pompa_acqua',    icon: 'üåä',  label: 'Pompa Acqua',              color: '#38bdf8' },
  { id: 'paraflu',        icon: 'üßä',  label: "Paraflu'",                 color: '#818cf8' },
  { id: 'cavi_candele',   icon: 'üîå',  label: 'Sost. Cavi Candele',       color: '#facc15' },
  { id: 'bobina',         icon: 'üîÜ',  label: 'Sostituzione Bobina',      color: '#fb923c' },
  { id: 'cuffie_giunti',  icon: 'üîó',  label: 'Cuffie Giunti',            color: '#a78bfa' },
  { id: 'bracci_ant',     icon: 'üî©',  label: 'Bracci Ant.',              color: '#9ca3af' },
  { id: 'bracci_post',    icon: 'üî©',  label: 'Bracci Post.',             color: '#9ca3af' },
  { id: 'marmitta_centr', icon: 'üí®',  label: 'Marmitta Centr.',          color: '#6b7280' },
  { id: 'marmitta_post',  icon: 'üí®',  label: 'Marmitta Post.',           color: '#6b7280' },
  { id: 'cinghia_dist',   icon: '‚öôÔ∏è',  label: 'Cinghia Distribuzione',    color: '#f43f5e' },
  { id: 'cinghia_org',    icon: '‚öôÔ∏è',  label: 'Cinghia Organi Aus.',      color: '#ec4899' },
  { id: 'freni_ant',      icon: 'üõë',  label: 'Freni Anteriori',          color: '#ef4444' },
  { id: 'freni_post',     icon: 'üõë',  label: 'Freni Posteriori',         color: '#dc2626' },
  { id: 'dischi_ant',     icon: '‚≠ï',  label: 'Dischi Freni Ant.',        color: '#f87171' },
  { id: 'dischi_post',    icon: '‚≠ï',  label: 'Dischi Freni Post.',       color: '#fca5a5' },
  { id: 'tagliando',      icon: 'üìã',  label: 'Tagliando',                color: '#e8c547' },
  { id: 'altro',          icon: 'üî®',  label: 'Altro Intervento',         color: '#94a3b8' },
];
function getMechType(id) { return MECH_TYPES.find(t => t.id === id) || { icon: 'üîß', label: id, color: '#94a3b8' }; }
function mechIcon(id) { return getMechType(id).icon; }
function mechLabel(id) { return getMechType(id).label; }
function formatDate(dateStr) {
  if (!dateStr) return '‚Äî';
  return new Date(dateStr).toLocaleDateString('it-IT', { day: '2-digit', month: 'short', year: 'numeric' });
}
function formatCurrency(n) { return n ? '‚Ç¨ ' + Number(n).toLocaleString('it-IT') : '‚Äî'; }
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

// ===== MECH TYPE GRID (MULTI-SELECT) =====
let _selectedMechTypes = [];

function buildMechTypeGrid(selectedIds = []) {
  _selectedMechTypes = Array.isArray(selectedIds) ? [...selectedIds] : (selectedIds ? [selectedIds] : []);
  const grid = document.getElementById('mech-type-grid');
  if (!grid) return;
  grid.innerHTML = MECH_TYPES.map(t => {
    const sel = _selectedMechTypes.includes(t.id);
    return `<button type="button" class="mech-type-btn ${sel ? 'selected' : ''}"
      onclick="toggleMechType('${t.id}')"
      style="${sel ? `border-color:${t.color};color:${t.color};background:${t.color}18` : ''}">
      <span class="mt-icon">${t.icon}</span>
      <span>${t.label}</span>
    </button>`;
  }).join('');
  updateSelectedTags();
}

function toggleMechType(id) {
  const idx = _selectedMechTypes.indexOf(id);
  if (idx >= 0) {
    _selectedMechTypes.splice(idx, 1);
  } else {
    _selectedMechTypes.push(id);
  }
  document.getElementById('m-type').value = _selectedMechTypes.join(',');
  document.getElementById('m-type-error').style.display = 'none';
  // Update button visual
  const t = getMechType(id);
  const btn = [...document.querySelectorAll('.mech-type-btn')]
    .find(b => b.getAttribute('onclick') === `toggleMechType('${id}')`);
  if (btn) {
    const isNowSelected = _selectedMechTypes.includes(id);
    if (isNowSelected) {
      btn.classList.add('selected');
      btn.style.borderColor = t.color; btn.style.color = t.color; btn.style.background = t.color + '18';
    } else {
      btn.classList.remove('selected');
      btn.style.borderColor = ''; btn.style.color = ''; btn.style.background = '';
    }
  }
  updateSelectedTags();
}

function updateSelectedTags() {
  const wrap = document.getElementById('m-selected-tags');
  if (!wrap) return;
  if (_selectedMechTypes.length === 0) { wrap.innerHTML = ''; return; }
  wrap.innerHTML = _selectedMechTypes.map(id => {
    const t = getMechType(id);
    return `<span class="mech-selected-tag" style="background:${t.color}15;color:${t.color};border-color:${t.color}40">
      ${t.icon} ${t.label}
      <button onclick="toggleMechType('${id}')" title="Rimuovi">√ó</button>
    </span>`;
  }).join('');
}

function removeMechTypeTag(id) { toggleMechType(id); }

// Legacy single-select shim (not used but keep for safety)
function selectMechType(id) { toggleMechType(id); }

// ===== MODAL =====
function openModal(id) {
  const m = document.getElementById(id);
  // If vehicle modal is opened fresh (not from openEditVehicle), reset the form
  if (id === 'vehicle-modal' && !document.getElementById('v-edit-id').value) {
    m.querySelectorAll('input:not(#v-edit-id), textarea').forEach(el => { el.value = ''; });
    const typeEl = document.getElementById('v-type');
    if (typeEl) typeEl.selectedIndex = 0;
  }
  m.classList.add('open');
  if (id === 'tire-modal') populateVehicleSelect('t-vehicle');
  if (id === 'mech-modal') {
    populateVehicleSelect('m-vehicle');
    document.getElementById('m-type').value = '';
    buildMechTypeGrid([]);
  }
  const today = new Date().toISOString().split('T')[0];
  m.querySelectorAll('input[type="date"]').forEach(inp => { if (!inp.value) inp.value = today; });
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  if (id === 'vehicle-modal') {
    document.getElementById('v-edit-id').value = '';
    document.getElementById('vehicle-modal-title').textContent = 'üöó Aggiungi Veicolo';
    document.getElementById('btn-save-vehicle').textContent = 'Salva Veicolo';
  }
  if (id === 'tire-modal') {
    document.getElementById('t-edit-id').value = '';
    document.getElementById('tire-modal-title').textContent = 'üîÑ Registra Cambio Gomme';
    document.getElementById('btn-save-tire').textContent = 'Salva';
  }
  if (id === 'mech-modal') {
    document.getElementById('m-edit-id').value = '';
    document.getElementById('mech-modal-title').textContent = 'üîß Aggiungi Intervento';
    document.getElementById('btn-save-mech').textContent = 'Salva';
    buildMechTypeGrid([]);
  }
}
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); });
});
function populateVehicleSelect(selectId) {
  const sel = document.getElementById(selectId);
  sel.innerHTML = data.vehicles.length === 0
    ? '<option value="">‚Äî Nessun veicolo ‚Äî</option>'
    : data.vehicles.map(v => `<option value="${v.id}">${v.plate} ‚Äî ${v.model}</option>`).join('');
}

// ===== TAB =====
function switchTab(name, vehicleId) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('section-' + name).classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
  // If a vehicleId is passed, pre-set the filter for that section
  if (vehicleId) {
    if (name === 'scadenze') {
      const sel = document.getElementById('scad-filter-vehicle');
      if (sel) sel.value = vehicleId;
    }
    if (name === 'meccanica') {
      const sel = document.getElementById('mech-filter-vehicle');
      if (sel) sel.value = vehicleId;
    }
    if (name === 'pneumatici') {
      const sel = document.getElementById('tire-filter-vehicle');
      if (sel) sel.value = vehicleId;
    }
  }
  renderAll();
}
window.switchTab = switchTab;

// ===== BUTTON LOADING =====
function setButtonLoading(btnId, loading) {
  const btn = document.getElementById(btnId);
  if (!btn) return;
  btn.disabled = loading;
  btn.style.opacity = loading ? '0.6' : '1';
  if (loading) btn.dataset.orig = btn.textContent;
  btn.textContent = loading ? 'Salvataggio...' : (btn.dataset.orig || 'Salva');
}

// ===== EDIT VEHICLE =====
function openEditVehicle(id) {
  const v = data.vehicles.find(x => x.id === id);
  if (!v) return;
  // Fill modal fields
  document.getElementById('v-edit-id').value = v.id;
  document.getElementById('v-plate').value = v.plate || '';
  document.getElementById('v-model').value = v.model || '';
  document.getElementById('v-year').value = v.year || '';
  document.getElementById('v-km').value = v.km || '';
  document.getElementById('v-km-date').value = v.kmDate || '';
  document.getElementById('v-bollo').value = v.bollo || '';
  document.getElementById('v-bollo-cost').value = v.bolloCost || '';
  document.getElementById('v-revisione').value = v.revisione || '';
  document.getElementById('v-revisione-cost').value = v.revisioneCost || '';
  document.getElementById('v-assicurazione').value = v.assicurazione || '';
  document.getElementById('v-assicurazione-cost').value = v.assicurazioneCost || '';
  document.getElementById('v-assicurazione-company').value = v.assicurazioneCompany || '';
  document.getElementById('v-note').value = v.note || '';
  // Set type select
  const typeEl = document.getElementById('v-type');
  if (v.type) typeEl.value = v.type;
  // Update modal title & button
  document.getElementById('vehicle-modal-title').textContent = '‚úèÔ∏è Modifica Veicolo';
  document.getElementById('btn-save-vehicle').textContent = 'Aggiorna Veicolo';
  openModal('vehicle-modal');
}

// ===== SAVE VEHICLE =====
async function saveVehicle() {
  const plate = document.getElementById('v-plate').value.trim().toUpperCase();
  const model = document.getElementById('v-model').value.trim();
  if (!plate || !model) { alert('Targa e modello sono obbligatori'); return; }
  const editId = document.getElementById('v-edit-id').value;
  const isEdit = !!editId;
  const existing = isEdit ? data.vehicles.find(x => x.id === editId) : null;
  const v = {
    id: isEdit ? editId : uid(),
    plate, model,
    type: document.getElementById('v-type').value,
    year: document.getElementById('v-year').value,
    km: document.getElementById('v-km').value,
    kmDate: document.getElementById('v-km-date').value,
    bollo: document.getElementById('v-bollo').value,
    bolloCost: document.getElementById('v-bollo-cost').value,
    revisione: document.getElementById('v-revisione').value,
    revisioneCost: document.getElementById('v-revisione-cost').value,
    assicurazione: document.getElementById('v-assicurazione').value,
    assicurazioneCost: document.getElementById('v-assicurazione-cost').value,
    assicurazioneCompany: document.getElementById('v-assicurazione-company').value,
    note: document.getElementById('v-note').value,
    createdAt: isEdit ? (existing?.createdAt || new Date().toISOString()) : new Date().toISOString(),
    addedBy: isEdit ? (existing?.addedBy || currentUser?.email || '?') : (currentUser ? currentUser.email : '?'),
    updatedAt: new Date().toISOString(),
  };
  setButtonLoading('btn-save-vehicle', true);
  try {
    await addVehicle(v); // addVehicle uses setDoc so works for both add & update
    closeModal('vehicle-modal');
    // Reset form
    document.getElementById('vehicle-modal').querySelectorAll('input, textarea, select').forEach(el => {
      if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = '';
    });
    document.getElementById('v-edit-id').value = '';
    document.getElementById('vehicle-modal-title').textContent = 'üöó Aggiungi Veicolo';
    document.getElementById('btn-save-vehicle').textContent = 'Salva Veicolo';
  } catch(e) { alert('Errore: ' + e.message); }
  setButtonLoading('btn-save-vehicle', false);
}

// ===== EDIT TIRE =====
function openEditTire(id) {
  const t = data.tires.find(x => x.id === id);
  if (!t) return;
  populateVehicleSelect('t-vehicle');
  document.getElementById('t-edit-id').value = t.id;
  document.getElementById('t-vehicle').value = t.vehicleId || '';
  document.getElementById('t-season').value  = t.season   || 'invernale';
  document.getElementById('t-date').value    = t.date     || '';
  document.getElementById('t-km').value      = t.km       || '';
  document.getElementById('t-km-next').value = t.kmNext   || '';
  document.getElementById('t-brand').value   = t.brand    || '';
  document.getElementById('t-size').value    = t.size     || '';
  document.getElementById('t-note').value    = t.note     || '';
  document.getElementById('tire-modal-title').textContent = '‚úèÔ∏è Modifica Cambio Gomme';
  document.getElementById('btn-save-tire').textContent    = 'Aggiorna';
  openModal('tire-modal');
}

// ===== SAVE TIRE =====
async function saveTire() {
  const vid = document.getElementById('t-vehicle').value;
  if (!vid) { alert('Seleziona un veicolo'); return; }
  const editId   = document.getElementById('t-edit-id').value;
  const isEdit   = !!editId;
  const existing = isEdit ? data.tires.find(x => x.id === editId) : null;
  const t = {
    id: isEdit ? editId : uid(),
    vehicleId: vid,
    season:  document.getElementById('t-season').value,
    date:    document.getElementById('t-date').value,
    km:      document.getElementById('t-km').value,
    kmNext:  document.getElementById('t-km-next').value,
    brand:   document.getElementById('t-brand').value,
    size:    document.getElementById('t-size').value,
    note:    document.getElementById('t-note').value,
    createdAt:  isEdit ? (existing?.createdAt || new Date().toISOString()) : new Date().toISOString(),
    updatedAt:  new Date().toISOString(),
  };
  setButtonLoading('btn-save-tire', true);
  try {
    await addTire(t);
    closeModal('tire-modal');
    document.getElementById('t-edit-id').value = '';
    document.getElementById('tire-modal-title').textContent = 'üîÑ Registra Cambio Gomme';
    document.getElementById('btn-save-tire').textContent    = 'Salva';
  } catch(e) { alert('Errore: ' + e.message); }
  setButtonLoading('btn-save-tire', false);
}

// ===== EDIT MECH =====
function openEditMech(id) {
  const m = data.mechs.find(x => x.id === id);
  if (!m) return;
  populateVehicleSelect('m-vehicle');
  document.getElementById('m-edit-id').value  = m.id;
  document.getElementById('m-vehicle').value  = m.vehicleId || '';
  document.getElementById('m-date').value     = m.date      || '';
  document.getElementById('m-km').value       = m.km        || '';
  document.getElementById('m-cost').value     = m.cost      || '';
  document.getElementById('m-garage').value   = m.garage    || '';
  document.getElementById('m-note').value     = m.note      || '';
  // Pre-select the single type
  buildMechTypeGrid(m.type ? [m.type] : []);
  document.getElementById('m-type').value = m.type || '';
  document.getElementById('mech-modal-title').textContent = '‚úèÔ∏è Modifica Intervento';
  document.getElementById('btn-save-mech').textContent    = 'Aggiorna';
  openModal('mech-modal');
}

// ===== SAVE MECH (multi-type on add, single on edit) =====
async function saveMech() {
  const vid    = document.getElementById('m-vehicle').value;
  const editId = document.getElementById('m-edit-id').value;
  const isEdit = !!editId;

  if (!vid) { alert('Seleziona un veicolo'); return; }
  if (_selectedMechTypes.length === 0) {
    document.getElementById('m-type-error').style.display = 'block'; return;
  }

  const existing = isEdit ? data.mechs.find(x => x.id === editId) : null;
  const base = {
    vehicleId: vid,
    date:   document.getElementById('m-date').value,
    km:     document.getElementById('m-km').value,
    cost:   document.getElementById('m-cost').value,
    garage: document.getElementById('m-garage').value,
    note:   document.getElementById('m-note').value,
    createdAt: isEdit ? (existing?.createdAt || new Date().toISOString()) : new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    addedBy: isEdit ? (existing?.addedBy || currentUser?.email || '?') : (currentUser?.email || '?'),
  };

  setButtonLoading('btn-save-mech', true);
  try {
    if (isEdit) {
      // Update single record keeping same id, with the (possibly changed) type
      await addMech({ ...base, id: editId, type: _selectedMechTypes[0] });
    } else {
      // Add ‚Äî one record per selected type
      await Promise.all(_selectedMechTypes.map(type => addMech({ ...base, id: uid(), type })));
    }
    closeModal('mech-modal');
    ['m-km','m-cost','m-garage','m-note'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('m-type').value  = '';
    document.getElementById('m-edit-id').value = '';
    document.getElementById('mech-modal-title').textContent = 'üîß Aggiungi Intervento';
    document.getElementById('btn-save-mech').textContent    = 'Salva';
    buildMechTypeGrid([]);
  } catch(e) { alert('Errore: ' + e.message); }
  setButtonLoading('btn-save-mech', false);
}

// ===== DELETE =====
async function deleteVehicle(id) {
  if (!confirm('Eliminare questo veicolo e tutti i suoi dati?')) return;
  try { await removeVehicle(id); } catch(e) { alert('Errore: ' + e.message); }
}
async function deleteTire(id) {
  try { await removeTire(id); } catch(e) { alert('Errore: ' + e.message); }
}
async function deleteMech(id) {
  try { await removeMech(id); } catch(e) { alert('Errore: ' + e.message); }
}

// ===== RENDER DASHBOARD =====
function renderDashboard() {
  const grid = document.getElementById('vehicle-grid');
  const statsRow = document.getElementById('stats-row');
  const totalCosts = data.mechs.reduce((s, m) => s + (parseFloat(m.cost) || 0), 0);
  const expiring = data.vehicles.filter(v => {
    const b = daysUntil(v.bollo), r = daysUntil(v.revisione);
    return (b !== null && b <= 60) || (r !== null && r <= 60);
  }).length;

  statsRow.innerHTML = `
    <div class="stat-card"><div class="stat-value">${data.vehicles.length}</div><div class="stat-label">Veicoli totali</div></div>
    <div class="stat-card"><div class="stat-value">${data.tires.length}</div><div class="stat-label">Cambi gomme</div></div>
    <div class="stat-card"><div class="stat-value">${data.mechs.length}</div><div class="stat-label">Interventi</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--accent)">‚Ç¨${Math.round(totalCosts).toLocaleString('it-IT')}</div><div class="stat-label">Costi totali</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--accent2)">${(data.members.filter(m=>m.status==='active').length + 1)}</div><div class="stat-label">Membri</div></div>
    ${expiring > 0 ? `<div class="stat-card"><div class="stat-value" style="color:var(--yellow)">${expiring}</div><div class="stat-label">Scadenze vicine</div></div>` : ''}
  `;

  if (data.vehicles.length === 0) {
    grid.innerHTML = `<div class="add-vehicle-card" onclick="openModal('vehicle-modal')"><div class="add-icon">üöó</div><span>Aggiungi il tuo primo veicolo</span></div>`;
    return;
  }
  grid.innerHTML = data.vehicles.map(v => {
    const bolloD = daysUntil(v.bollo);
    const revD = daysUntil(v.revisione);
    const assicD = daysUntil(v.assicurazione);
    const allDays = [bolloD, revD, assicD].filter(d => d !== null);
    const minDays = allDays.length ? Math.min(...allDays) : null;
    const cardClass = minDays === null ? 'ok' : minDays <= 10 ? 'danger' : minDays <= 60 ? 'warn' : 'ok';
    const bolloCostStr = v.bolloCost ? ' ¬∑ ‚Ç¨'+Number(v.bolloCost).toLocaleString('it-IT') : '';
    const revCostStr = v.revisioneCost ? ' ¬∑ ‚Ç¨'+Number(v.revisioneCost).toLocaleString('it-IT') : '';
    const assicCostStr = v.assicurazioneCost ? ' ¬∑ ‚Ç¨'+Number(v.assicurazioneCost).toLocaleString('it-IT') : '';
    const bolloBadge = bolloD !== null ? `<span class="badge ${badgeClass(bolloD)}"><span class="status-dot ${badgeClass(bolloD)}"></span>Bollo: ${bolloD >= 0 ? bolloD+'gg' : 'SCADUTO'}${bolloCostStr}</span>` : '';
    const revBadge = revD !== null ? `<span class="badge ${badgeClass(revD)}"><span class="status-dot ${badgeClass(revD)}"></span>Revisione: ${revD >= 0 ? revD+'gg' : 'SCADUTA'}${revCostStr}</span>` : '';
    const assicBadge = assicD !== null ? `<span class="badge ${badgeClass(assicD)}"><span class="status-dot ${badgeClass(assicD)}"></span>üõ°Ô∏è Assic.${v.assicurazioneCompany ? ' '+v.assicurazioneCompany : ''}: ${assicD >= 0 ? assicD+'gg' : 'SCADUTA'}${assicCostStr}</span>` : '';
    const addedBy = v.addedBy ? `<div style="font-size:11px;color:var(--text2);margin-top:4px">üë§ ${v.addedBy}</div>` : '';
    return `
      <div class="vehicle-card ${cardClass}">
        <div class="vc-header">
          <div><div class="vc-type">${typeIcon(v.type)}</div><div class="vc-plate">${v.plate}</div></div>
          <div style="display:flex;gap:6px;align-items:center">
            <button class="edit-btn" onclick="openEditVehicle('${v.id}')">‚úèÔ∏è</button>
            <button class="delete-btn" onclick="deleteVehicle('${v.id}')">üóëÔ∏è</button>
          </div>
        </div>
        <div class="vc-model">${v.model}</div>
        <div style="color:var(--text2);font-size:12px">${v.year ? v.year+' ¬∑ ' : ''}${v.km ? Number(v.km).toLocaleString('it-IT')+' km' : ''}${v.kmDate ? ' <span style="color:var(--text2);opacity:0.6">al '+formatDate(v.kmDate)+'</span>' : ''}</div>
        ${addedBy}
        <div class="vc-badges">${bolloBadge}${revBadge}${assicBadge}</div>
        <div class="vc-actions">
          <button class="btn btn-secondary btn-sm" onclick="switchTab('scadenze','${v.id}')">üìÖ Scadenze</button>
          <button class="btn btn-secondary btn-sm" onclick="switchTab('meccanica','${v.id}')">üîß Storico</button>
        </div>
      </div>`;
  }).join('') + `<div class="add-vehicle-card" onclick="openModal('vehicle-modal')"><div class="add-icon">‚ûï</div><span>Aggiungi veicolo</span></div>`;
}

// ===== RENDER SCADENZE =====
function renderScadenze() {
  const sel = document.getElementById('scad-filter-vehicle');
  const filterV = sel.value;
  const list = document.getElementById('scadenze-list');
  sel.innerHTML = '<option value="">Tutti i veicoli</option>' +
    data.vehicles.map(v => `<option value="${v.id}" ${filterV===v.id?'selected':''}>${v.plate} ‚Äî ${v.model}</option>`).join('');
  let items = [];
  data.vehicles.filter(v => !filterV || v.id === filterV).forEach(v => {
    if (v.bollo) items.push({ vehicle: v, type: 'bollo', date: v.bollo, icon: 'üìã', label: 'Bollo', cost: v.bolloCost });
    if (v.revisione) items.push({ vehicle: v, type: 'revisione', date: v.revisione, icon: 'üîç', label: 'Revisione', cost: v.revisioneCost });
    if (v.assicurazione) items.push({ vehicle: v, type: 'assicurazione', date: v.assicurazione, icon: 'üõ°Ô∏è', label: v.assicurazioneCompany ? 'Assicurazione '+v.assicurazioneCompany : 'Assicurazione', cost: v.assicurazioneCost });
  });
  if (items.length === 0) { list.innerHTML = `<div class="empty-state"><div class="empty-icon">üìÖ</div><p>Nessuna scadenza registrata.</p></div>`; return; }
  items.sort((a, b) => new Date(a.date) - new Date(b.date));
  const colors = { green: 'var(--green)', yellow: 'var(--yellow)', red: 'var(--red)' };
  list.innerHTML = items.map(item => {
    const days = daysUntil(item.date);
    const cls = badgeClass(days);
    const daysText = days === null ? '?' : days < 0 ? 'SCADUTO' : days === 0 ? 'OGGI' : days + ' giorni';
    const pct = days === null ? 100 : Math.max(0, Math.min(100, (days / 365) * 100));
    const color = colors[cls] || 'var(--green)';
    return `<div class="scadenza-item">
      <div class="sc-icon">${item.icon}</div>
      <div class="sc-info">
        <div class="sc-title">${item.label} ‚Äî ${item.vehicle.plate}${item.cost ? ` <span style="color:var(--accent);font-size:13px;font-weight:700">¬∑ ‚Ç¨${Number(item.cost).toLocaleString('it-IT')}</span>` : ''}</div>
        <div class="sc-sub">${item.vehicle.model} ¬∑ Scade: ${formatDate(item.date)}</div>
        <div class="progress-bar" style="margin-top:8px"><div class="progress-fill" style="width:${pct}%;background:${color}"></div></div>
      </div>
      <div class="sc-days" style="color:${color}">${daysText}</div>
    </div>`;
  }).join('');
}

// ===== RENDER PNEUMATICI =====
function renderPneumatici() {
  const sel = document.getElementById('tire-filter-vehicle');
  const filterV = sel.value;
  const grid = document.getElementById('tire-grid');
  sel.innerHTML = '<option value="">Tutti i veicoli</option>' +
    data.vehicles.map(v => `<option value="${v.id}" ${filterV===v.id?'selected':''}>${v.plate} ‚Äî ${v.model}</option>`).join('');
  const tires = data.tires.filter(t => !filterV || t.vehicleId === filterV).sort((a,b) => new Date(b.date)-new Date(a.date));
  if (tires.length === 0) { grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üîÑ</div><p>Nessun cambio gomme registrato.</p></div>`; return; }
  grid.innerHTML = tires.map(t => {
    const v = data.vehicles.find(v => v.id === t.vehicleId);
    const vLabel = v ? `${v.plate} ‚Äî ${v.model}` : 'Veicolo rimosso';
    const seasonLabel = { invernale: '‚ùÑÔ∏è Invernale', estivo: '‚òÄÔ∏è Estivo', allseason: 'üå¶Ô∏è 4 Stagioni' }[t.season] || t.season;
    return `<div class="tire-card">
      <div class="tire-header">
        <div class="tire-icon">üîÑ</div>
        <div style="flex:1"><div style="font-family:var(--font-display);font-weight:700;font-size:14px">${vLabel}</div></div>
        <span class="tire-season ${t.season}">${seasonLabel}</span>
        <div style="display:flex;gap:4px;align-items:center">
          <button class="edit-btn" onclick="openEditTire('${t.id}')">‚úèÔ∏è</button>
          <button class="delete-btn" onclick="deleteTire('${t.id}')">üóëÔ∏è</button>
        </div>
      </div>
      <div class="tire-detail">üìÖ <strong>${formatDate(t.date)}</strong>${t.km ? ' ¬∑ '+Number(t.km).toLocaleString('it-IT')+' km' : ''}</div>
      ${t.brand ? `<div class="tire-detail">üè∑Ô∏è <strong>${t.brand}</strong>${t.size ? ' ‚Äî '+t.size : ''}</div>` : ''}
      ${t.kmNext ? `<div class="tire-detail">‚è≠Ô∏è Prossimo: <strong>${Number(t.kmNext).toLocaleString('it-IT')} km</strong></div>` : ''}
      ${t.note ? `<div class="tire-detail" style="color:var(--text2);font-size:12px;margin-top:8px">${t.note}</div>` : ''}
    </div>`;
  }).join('');
}

// ===== RENDER MECCANICA =====
function mechItemHTML(m) {
  const v = data.vehicles.find(v => v.id === m.vehicleId);
  const vLabel = v ? `${v.plate} ‚Äî ${v.model}` : 'Veicolo rimosso';
  const mt = getMechType(m.type);
  return `<div class="mech-item">
    <div class="mech-icon-wrap" style="background:${mt.color}1a;border:1px solid ${mt.color}33">${mt.icon}</div>
    <div class="mech-info">
      <div class="mech-title">${mt.label}</div>
      <div class="mech-sub">${vLabel} ¬∑ ${formatDate(m.date)}${m.km ? ' ¬∑ '+Number(m.km).toLocaleString('it-IT')+' km' : ''}${m.garage ? ' ¬∑ üè™ '+m.garage : ''}</div>
      ${m.note ? `<div style="font-size:12px;color:var(--text2);margin-top:4px;padding:6px 8px;background:var(--surface2);border-radius:8px">${m.note}</div>` : ''}
      ${m.addedBy ? `<div style="font-size:11px;color:var(--text2);margin-top:4px">üë§ ${m.addedBy}</div>` : ''}
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
      <div class="mech-cost">${formatCurrency(m.cost)}</div>
      <div style="display:flex;gap:4px;justify-content:flex-end">
        <button class="edit-btn" onclick="openEditMech('${m.id}')">‚úèÔ∏è</button>
        <button class="delete-btn" onclick="deleteMech('${m.id}')">üóëÔ∏è</button>
      </div>
    </div>
  </div>`;
}

function toggleYearGroup(year) {
  const header = document.getElementById('yh-' + year);
  const body   = document.getElementById('yb-' + year);
  if (!header || !body) return;
  const isOpen = body.classList.contains('open');
  body.classList.toggle('open', !isOpen);
  header.classList.toggle('open', !isOpen);
}
window.toggleYearGroup = toggleYearGroup;

function renderMeccanica() {
  const selV = document.getElementById('mech-filter-vehicle');
  const selT = document.getElementById('mech-filter-type');
  const filterV = selV.value, filterT = selT.value;
  const list = document.getElementById('mech-list');
  selV.innerHTML = '<option value="">Tutti i veicoli</option>' +
    data.vehicles.map(v => `<option value="${v.id}" ${filterV===v.id?'selected':''}>${v.plate} ‚Äî ${v.model}</option>`).join('');

  let mechs = data.mechs
    .filter(m => (!filterV || m.vehicleId === filterV) && (!filterT || m.type === filterT))
    .sort((a,b) => new Date(b.date) - new Date(a.date));

  if (mechs.length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="empty-icon">üîß</div><p>Nessun intervento registrato.</p></div>`;
    return;
  }

  // Group by year
  const byYear = {};
  mechs.forEach(m => {
    const yr = m.date ? new Date(m.date).getFullYear() : 'N/D';
    if (!byYear[yr]) byYear[yr] = [];
    byYear[yr].push(m);
  });

  const years = Object.keys(byYear).sort((a,b) => b - a); // newest first
  const totalCost = mechs.reduce((s,m) => s+(parseFloat(m.cost)||0), 0);

  // Summary bar
  let html = `<div style="margin-bottom:18px;color:var(--text2);font-size:13px">
    ${mechs.length} interventi ¬∑ ${years.length} ${years.length===1?'anno':'anni'} ¬∑ Totale: <strong style="color:var(--accent)">‚Ç¨${totalCost.toLocaleString('it-IT')}</strong>
  </div>`;

  years.forEach((yr, idx) => {
    const items = byYear[yr];
    const yrCost = items.reduce((s,m) => s+(parseFloat(m.cost)||0), 0);
    const isCurrentYear = yr == new Date().getFullYear();
    // Auto-open current year and most recent year
    const autoOpen = idx === 0 || isCurrentYear;

    html += `<div class="year-group">
      <div class="year-header ${autoOpen ? 'open' : ''}" id="yh-${yr}" onclick="toggleYearGroup('${yr}')">
        <div class="year-header-left">
          <span class="year-label">${yr}</span>
          <span class="year-count">${items.length} interventi</span>
          ${isCurrentYear ? `<span style="font-size:11px;color:var(--green);font-weight:700;font-family:var(--font-display)">‚óè in corso</span>` : ''}
        </div>
        <div style="display:flex;align-items:center;gap:14px">
          ${yrCost > 0 ? `<span class="year-cost">‚Ç¨${yrCost.toLocaleString('it-IT')}</span>` : ''}
          <span class="year-chevron">‚ñº</span>
        </div>
      </div>
      <div class="year-body ${autoOpen ? 'open' : ''}" id="yb-${yr}">
        ${items.map(m => mechItemHTML(m)).join('')}
      </div>
    </div>`;
  });

  list.innerHTML = html;
}

// ===== RENDER FAMIGLIA =====
function renderFamiglia() {
  const grid = document.getElementById('family-grid');
  const vgrid = document.getElementById('family-vehicle-grid');
  if (!grid) return;

  // Build members list: owner first, then actives, then pending
  const owner = data.garageOwner;
  const members = data.members || [];
  const isCurrentOwner = isOwner;

  let html = '';
  // Owner card
  if (owner) {
    const isMe = currentUser && owner.uid === currentUser.uid;
    html += `<div class="family-card">
      ${owner.photo ? `<img class="family-avatar" src="${owner.photo}" alt="">` : `<div class="family-avatar-placeholder">üë§</div>`}
      <div class="family-info">
        <div class="family-name">${owner.name}${isMe ? ' <span style="color:var(--accent);font-size:11px">(tu)</span>' : ''}</div>
        <div class="family-email">${owner.email}</div>
      </div>
      <span class="family-role owner">üëë Proprietario</span>
    </div>`;
  }

  // Active members
  members.filter(m => m.status === 'active').forEach(m => {
    const isMe = currentUser && m.uid === currentUser.uid;
    html += `<div class="family-card">
      ${m.photo ? `<img class="family-avatar" src="${m.photo}" alt="">` : `<div class="family-avatar-placeholder">üë§</div>`}
      <div class="family-info">
        <div class="family-name">${m.name}${isMe ? ' <span style="color:var(--accent);font-size:11px">(tu)</span>' : ''}</div>
        <div class="family-email">${m.email}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        <span class="family-role member">‚úÖ Membro</span>
        ${isCurrentOwner ? `<button class="btn btn-danger btn-sm" onclick="removeMember('${m.email}')">Rimuovi</button>` : ''}
      </div>
    </div>`;
  });

  // Pending invites
  members.filter(m => m.status === 'pending').forEach(m => {
    html += `<div class="family-card">
      <div class="family-avatar-placeholder">‚úâÔ∏è</div>
      <div class="family-info">
        <div class="family-name">${m.email}</div>
        <div class="family-email">Invitato il ${formatDate(m.invitedAt)}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        <span class="family-role pending">‚è≥ In attesa</span>
        ${isCurrentOwner ? `<button class="btn btn-danger btn-sm" onclick="removeMember('${m.email}')">Annulla</button>` : ''}
      </div>
    </div>`;
  });

  grid.innerHTML = html || '<div style="color:var(--text2);font-size:13px">Nessun membro ancora.</div>';

  // Show/hide invite box based on ownership
  document.getElementById('invite-box').style.display = isCurrentOwner ? '' : 'none';

  // Render shared vehicles
  if (vgrid) {
    if (data.vehicles.length === 0) {
      vgrid.innerHTML = '<div style="color:var(--text2);font-size:13px;grid-column:1/-1">Nessun veicolo nel garage.</div>';
    } else {
      vgrid.innerHTML = data.vehicles.map(v => {
        const bolloD = daysUntil(v.bollo);
        const revD = daysUntil(v.revisione);
        const worstDays = [bolloD, revD].filter(d => d !== null);
        const minDays = worstDays.length ? Math.min(...worstDays) : null;
        const cardClass = minDays === null ? 'ok' : minDays <= 10 ? 'danger' : minDays <= 60 ? 'warn' : 'ok';
        const bolloBadge = bolloD !== null ? `<span class="badge ${badgeClass(bolloD)}">Bollo: ${bolloD >= 0 ? bolloD+'gg' : 'SCADUTO'}</span>` : '';
        const revBadge = revD !== null ? `<span class="badge ${badgeClass(revD)}">Rev: ${revD >= 0 ? revD+'gg' : 'SCADUTA'}</span>` : '';
        return `<div class="vehicle-card ${cardClass}">
          <div class="vc-header">
            <div><div class="vc-type">${typeIcon(v.type)}</div><div class="vc-plate">${v.plate}</div></div>
          </div>
          <div class="vc-model">${v.model}</div>
          <div style="color:var(--text2);font-size:12px">${v.year ? v.year+' ¬∑ ' : ''}${v.km ? Number(v.km).toLocaleString('it-IT')+' km' : ''}${v.kmDate ? ' <span style="color:var(--text2);opacity:0.6">al '+formatDate(v.kmDate)+'</span>' : ''}</div>
          ${v.addedBy ? `<div style="font-size:11px;color:var(--text2);margin-top:4px">üë§ ${v.addedBy}</div>` : ''}
          <div class="vc-badges" style="margin-top:10px">${bolloBadge}${revBadge}</div>
        </div>`;
      }).join('');
    }
  }
}

window.removeMember = async function(email) {
  if (!confirm(`Rimuovere ${email} dal garage?`)) return;
  const garageRef = doc(db, 'garages', garageId);
  const snap = await getDoc(garageRef);
  const members = (snap.data().members || []).filter(m => m.email !== email);
  await setDoc(garageRef, { members }, { merge: true });
};

// ===== NOTIFICATIONS =====
function renderNotifications() {
  const bar = document.getElementById('notif-bar');
  const scroll = document.getElementById('notif-scroll');
  const chips = [];
  data.vehicles.forEach(v => {
    const bolloD = daysUntil(v.bollo);
    const revD = daysUntil(v.revisione);
    if (bolloD !== null && bolloD <= 30) chips.push({ cls: bolloD <= 10 ? 'red' : 'yellow', text: `${v.plate} ¬∑ Bollo: ${bolloD <= 0 ? 'SCADUTO' : bolloD+'gg'}` });
    if (revD !== null && revD <= 30) chips.push({ cls: revD <= 10 ? 'red' : 'yellow', text: `${v.plate} ¬∑ Revisione: ${revD <= 0 ? 'SCADUTA' : revD+'gg'}` });
  });
  if (chips.length === 0) { bar.classList.remove('has-notifs'); scroll.innerHTML = ''; return; }
  bar.classList.add('has-notifs');
  scroll.innerHTML = `<span class="notif-label">‚ö†Ô∏è AVVISI:</span>` + chips.map(c => `<span class="notif-chip ${c.cls}">${c.text}</span>`).join('');
}
// ===== RENDER ALL =====
function renderAll() {
  const user = JSON.parse(localStorage.getItem('garage_user'));
  
  if (user) {
    currentUser = user;
    setStatus('dashboard');
    initDashboard();
    renderScadenze();
    renderPneumatici();
    renderMeccanica();
    renderFamiglia();
    renderNotifications();
  } else {
    if (typeof google !== 'undefined' && google.accounts) {
      setStatus('login');
      // QUESTA RIGA √à FONDAMENTALE:
      setTimeout(() => initGoogleAuth(), 100); 
    } else {
      console.log("In attesa di Google Auth...");
      setTimeout(renderAll, 200);
    }
  }
}

// ===== INIT =====
// Usiamo window.onload per essere sicuri che la pagina sia caricata tutta
window.onload = () => {
  setStatus('loading');
  renderAll();
};

</script>

<script>
// ===== SERVICE WORKER REGISTRATION & UPDATE =====
let _swWaiting = null;

function applyUpdate() {
  if (_swWaiting) {
    _swWaiting.postMessage({ type: 'SKIP_WAITING' });
  } else {
    window.location.reload();
  }
}
window.applyUpdate = applyUpdate;

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/garageOS/sw.js').then(reg => {
    // Controlla aggiornamento subito
    reg.update();

    reg.addEventListener('updatefound', () => {
      const newWorker = reg.installing;
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          // Nuova versione pronta!
          _swWaiting = newWorker;
          document.getElementById('update-banner').classList.add('show');
        }
      });
    });

    // Se SW gi√† in waiting al caricamento
    if (reg.waiting && navigator.serviceWorker.controller) {
      _swWaiting = reg.waiting;
      document.getElementById('update-banner').classList.add('show');
    }
  }).catch(err => console.log('SW registration failed:', err));

  // Ricarica automaticamente dopo che il nuovo SW prende il controllo
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    window.location.reload();
  });
}
</script>
</body>
</html>
